const a6_0x1f9a=['note','message','SIGTERM','strip-json-comments','Waiting...','Agent\x20','startAgent','includes','status','target','../../../utilities/waiter','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','getRunGroup','child_process','__esModule','env','wait','length','../../../utilities/create-unchanged-value-timeout','maxParallel','Agent\x20was\x20terminated\x20via\x20SIGINT','Waiter','next','executionId:\x20','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','../../../utilities/metric-logger','executionId','Other\x20Nx\x20Cloud\x20Agents\x20Detected','completed:\x20','NX_AGENT_NAME','RUN_GROUP_COMPLETED','reset','readdirSync','/lockfiles','retryDuring','apply','./node_modules/.cache/nx','floor','Agent\x20was\x20terminated\x20via\x20SIGTERM','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','submitRunMetrics','NO_MESSAGES_TIMEOUT','createUnchangedValueTimeout','params','Fetching\x20tasks...','No\x20new\x20messages\x20received\x20after\x20','default','criticalErrorMessage','forEach','existsSync','completeRunGroupWithError','error','push','printRunGroupError','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','projectName','cacheDirectory','projects','status:\x20','--configuration=','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','value','SIGINT','VERBOSE_LOGGING','assign','/tasks-hashes-','readFileSync','options','NO_FURTHER_TASKS_TO_RUN','unlinkSync','join','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','inherit','done','tasks','tasksRunnerOptions','\x20seconds','.lock','exit','number\x20of\x20tasks:\x20','CIRCLE_JOB','__awaiter','defineProperty','mkdirSync','../../../utilities/nx-imports','CIRCLE_STAGE','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','Critical\x20Error\x20in\x20Agent:\x20\x22','./distributed-agent.api','parse','Duplicate\x20Agent\x20ID\x20Detected','\x20--projects=','completedStatusCode','Executing:\x20\x27','then','CIRCLECI','API\x20Response','Error:','completedTasks','configuration','../../../utilities/environment','getTime','toString','writeFileSync','completed','execSync','true','catch',').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.'];(function(_0x599a70,_0x1f9a44){const _0x230ae2=function(_0x10417f){while(--_0x10417f){_0x599a70['push'](_0x599a70['shift']());}};_0x230ae2(++_0x1f9a44);}(a6_0x1f9a,0x1dc));const a6_0x230a=function(_0x599a70,_0x1f9a44){_0x599a70=_0x599a70-0x0;let _0x230ae2=a6_0x1f9a[_0x599a70];return _0x230ae2;};'use strict';var __awaiter=this&&this[a6_0x230a('0x29')]||function(_0x2050c6,_0x379c5c,_0x3a6fde,_0x4c3355){function _0x4baa3c(_0xb7ee8f){return _0xb7ee8f instanceof _0x3a6fde?_0xb7ee8f:new _0x3a6fde(function(_0x33e1d5){_0x33e1d5(_0xb7ee8f);});}return new(_0x3a6fde||(_0x3a6fde=Promise))(function(_0x54986b,_0x2b63a7){function _0x5c05d8(_0x5154fc){try{_0x5e579a(_0x4c3355['next'](_0x5154fc));}catch(_0x31bfe1){_0x2b63a7(_0x31bfe1);}}function _0x44c990(_0x1db1cb){try{_0x5e579a(_0x4c3355['throw'](_0x1db1cb));}catch(_0x5b4b43){_0x2b63a7(_0x5b4b43);}}function _0x5e579a(_0x46c7f6){_0x46c7f6[a6_0x230a('0x21')]?_0x54986b(_0x46c7f6[a6_0x230a('0x15')]):_0x4baa3c(_0x46c7f6[a6_0x230a('0x15')])['then'](_0x5c05d8,_0x44c990);}_0x5e579a((_0x4c3355=_0x4c3355[a6_0x230a('0x68')](_0x2050c6,_0x379c5c||[]))[a6_0x230a('0x5b')]());});};Object[a6_0x230a('0x2a')](exports,a6_0x230a('0x53'),{'value':!![]});exports[a6_0x230a('0x4b')]=void 0x0;const child_process_1=require(a6_0x230a('0x52'));const fs_1=require('fs');const stripJsonComments=require(a6_0x230a('0x48'));const create_unchanged_value_timeout_1=require(a6_0x230a('0x57'));const environment_1=require(a6_0x230a('0x3c'));const metric_logger_1=require(a6_0x230a('0x5e'));const waiter_1=require(a6_0x230a('0x4f'));const print_run_group_error_1=require('../../error/print-run-group-error');const distributed_agent_api_1=require(a6_0x230a('0x30'));const {output,workspaceRoot}=require(a6_0x230a('0x2c'));function executeTasks(_0x103ed9,_0x5a5319){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x5ef27b=0x0;let _0x254ff4=null;const _0x4f9201=(0x0,create_unchanged_value_timeout_1[a6_0x230a('0x2')])({'title':a6_0x230a('0x5')+environment_1[a6_0x230a('0x1')]/0x3e8+a6_0x230a('0x24'),'timeout':environment_1[a6_0x230a('0x1')]});const _0x31fcbe=new waiter_1[(a6_0x230a('0x5a'))]();let _0x20b8c2=[];const _0x5b95a7=new Date();let _0x8e29be=![];while(!![]){if(environment_1[a6_0x230a('0x17')]){output[a6_0x230a('0x45')]({'title':a6_0x230a('0x4')});}_0x254ff4=yield _0x5a5319['tasks'](_0x254ff4?_0x254ff4[a6_0x230a('0x5f')]:null,_0x5ef27b,_0x20b8c2);if(environment_1[a6_0x230a('0x17')]){output[a6_0x230a('0x45')]({'title':a6_0x230a('0x38'),'bodyLines':[a6_0x230a('0x61')+_0x254ff4[a6_0x230a('0x40')],a6_0x230a('0x12')+_0x254ff4[a6_0x230a('0x4d')],'retryDuring:\x20'+_0x254ff4[a6_0x230a('0x67')],a6_0x230a('0x5c')+_0x254ff4[a6_0x230a('0x5f')],a6_0x230a('0x27')+_0x254ff4[a6_0x230a('0x22')][a6_0x230a('0x56')],'error:\x20'+_0x254ff4['criticalErrorMessage'],'maxParallel:\x20'+_0x254ff4[a6_0x230a('0x58')]]});}if(_0x254ff4[a6_0x230a('0x7')]){output[a6_0x230a('0xb')]({'title':'Distributed\x20Execution\x20Terminated','bodyLines':[a6_0x230a('0x39'),_0x254ff4['criticalErrorMessage']]});process[a6_0x230a('0x26')](0x0);}if((_0x254ff4===null||_0x254ff4===void 0x0?void 0x0:_0x254ff4['retryDuring'])&&(_0x254ff4===null||_0x254ff4===void 0x0?void 0x0:_0x254ff4['retryDuring'])!==0x0&&!_0x8e29be&&new Date()[a6_0x230a('0x3d')]()-_0x5b95a7[a6_0x230a('0x3d')]()>_0x254ff4[a6_0x230a('0x67')]){yield _0x31fcbe[a6_0x230a('0x55')]();continue;}if((_0x254ff4===null||_0x254ff4===void 0x0?void 0x0:_0x254ff4[a6_0x230a('0x4d')])!==undefined){if(_0x254ff4[a6_0x230a('0x4d')]===a6_0x230a('0x63')||_0x254ff4[a6_0x230a('0x4d')]===a6_0x230a('0x1c')){return;}}else if(_0x254ff4[a6_0x230a('0x40')]){return;}_0x4f9201(_0x254ff4[a6_0x230a('0x22')]['map'](_0x1c9316=>_0x1c9316['taskId'])[a6_0x230a('0x1e')](''));if(!_0x254ff4[a6_0x230a('0x5f')]){if(environment_1[a6_0x230a('0x17')]){output[a6_0x230a('0x45')]({'title':a6_0x230a('0x49')});}yield _0x31fcbe[a6_0x230a('0x55')]();_0x5ef27b=0x0;_0x20b8c2=[];continue;}_0x31fcbe[a6_0x230a('0x64')]();_0x8e29be=!![];const _0x1deb7e=invokeTasksUsingRunMany(_0x103ed9,_0x254ff4['executionId'],_0x254ff4[a6_0x230a('0x22')],_0x254ff4[a6_0x230a('0x58')]);_0x5ef27b=_0x1deb7e[a6_0x230a('0x34')];_0x20b8c2=_0x1deb7e[a6_0x230a('0x3a')];}});}function readCompletedTasks(_0xfc0ce7,_0x1b361e){const _0xe69e9a=a6_0x230a('0x6c')+_0x1b361e+a6_0x230a('0x44');let _0x1b4def;try{const _0x3f7863=_0xfc0ce7[a6_0x230a('0x10')]||a6_0x230a('0x69');const _0x2dcc88=_0x3f7863+a6_0x230a('0x19')+_0x1b361e;_0x1b4def=JSON[a6_0x230a('0x31')]((0x0,fs_1[a6_0x230a('0x1a')])(_0x2dcc88)['toString']());(0x0,fs_1['unlinkSync'])(_0x2dcc88);}catch(_0x745925){throw new Error(_0xe69e9a);}if(_0x1b4def[a6_0x230a('0x56')]==0x0){throw new Error(_0xe69e9a);}return _0x1b4def;}function invokeTasksUsingRunMany(_0x346dbc,_0x1584b5,_0x52afa6,_0x628e16){let _0x57d256=0x0;const _0x3dfb72=[];for(const _0x340bfe of groupByTarget(_0x52afa6)){const _0x85e03c=_0x340bfe[a6_0x230a('0x3b')]?a6_0x230a('0x13')+_0x340bfe[a6_0x230a('0x3b')]:'';const _0x57373e=_0x628e16>0x1?'\x20--parallel\x20--max-parallel='+_0x628e16:'';const _0x54107c='npx\x20nx\x20run-many\x20--target='+_0x340bfe[a6_0x230a('0x4e')]+'\x20'+_0x85e03c+a6_0x230a('0x33')+_0x340bfe['projects'][a6_0x230a('0x1e')](',')+'\x20'+_0x340bfe[a6_0x230a('0x3')]+_0x57373e;if(environment_1['VERBOSE_LOGGING']){output[a6_0x230a('0x45')]({'title':a6_0x230a('0x35')+_0x54107c+'\x27'});}try{(0x0,child_process_1[a6_0x230a('0x41')])(_0x54107c,{'stdio':[a6_0x230a('0x20'),'inherit',a6_0x230a('0x20')],'env':Object[a6_0x230a('0x18')](Object['assign']({},process[a6_0x230a('0x54')]),{'NX_CACHE_FAILURES':a6_0x230a('0x42'),'NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x1584b5})});_0x3dfb72[a6_0x230a('0xc')](...readCompletedTasks(_0x346dbc,_0x1584b5));}catch(_0x58ac79){if(_0x58ac79[a6_0x230a('0x4d')]===environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']){throw _0x58ac79;}else{_0x57d256=0x1;_0x3dfb72[a6_0x230a('0xc')](...readCompletedTasks(_0x346dbc,_0x1584b5));}}}return{'completedStatusCode':_0x57d256,'completedTasks':_0x3dfb72};}function groupByTarget(_0x30e4ca){const _0x2f1ed7=[];_0x30e4ca[a6_0x230a('0x8')](_0x4e2fca=>{const _0x185162=_0x2f1ed7['find'](_0x45e9bb=>_0x45e9bb[a6_0x230a('0x4e')]===_0x4e2fca['target']&&_0x45e9bb[a6_0x230a('0x3b')]===_0x4e2fca[a6_0x230a('0x3b')]);if(_0x185162){_0x185162[a6_0x230a('0x11')][a6_0x230a('0xc')](_0x4e2fca[a6_0x230a('0xf')]);}else{_0x2f1ed7['push']({'target':_0x4e2fca[a6_0x230a('0x4e')],'projects':[_0x4e2fca['projectName']],'params':_0x4e2fca['params'],'configuration':_0x4e2fca[a6_0x230a('0x3b')]});}});return _0x2f1ed7;}function getAgentName(){if(process[a6_0x230a('0x54')][a6_0x230a('0x62')]!==undefined){return process[a6_0x230a('0x54')][a6_0x230a('0x62')];}else if(process[a6_0x230a('0x54')][a6_0x230a('0x37')]!==undefined&&process['env'][a6_0x230a('0x2d')]){return process['env'][a6_0x230a('0x2d')];}else if(process[a6_0x230a('0x54')][a6_0x230a('0x37')]!==undefined&&process[a6_0x230a('0x54')][a6_0x230a('0x28')]){return process[a6_0x230a('0x54')][a6_0x230a('0x28')];}else{return a6_0x230a('0x4a')+Math[a6_0x230a('0x6a')](Math['random']()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x293b0b,_0x168906,_0x27bcc7){const _0x195161=_0x168906[a6_0x230a('0x10')]||'./node_modules/.cache/nx';const _0x556286=_0x195161+a6_0x230a('0x66');const _0x3b2fbd=_0x556286+'/'+_0x27bcc7+a6_0x230a('0x25');if(!(0x0,fs_1[a6_0x230a('0x9')])(_0x556286)){(0x0,fs_1[a6_0x230a('0x2b')])(_0x556286,{'recursive':!![]});}const _0xdb5f11=(0x0,fs_1[a6_0x230a('0x65')])(_0x556286);if(_0xdb5f11[a6_0x230a('0x56')]){if(_0xdb5f11[a6_0x230a('0x4c')](_0x27bcc7+a6_0x230a('0x25'))){output[a6_0x230a('0xb')]({'title':a6_0x230a('0x32'),'bodyLines':[a6_0x230a('0xe'),'',a6_0x230a('0x14')]});process[a6_0x230a('0x26')](0x1);}output['warn']({'title':a6_0x230a('0x60'),'bodyLines':[a6_0x230a('0x2e'),'',a6_0x230a('0x5d'),a6_0x230a('0x1f')]});}(0x0,fs_1[a6_0x230a('0x3f')])(_0x3b2fbd,'');process['on'](a6_0x230a('0x26'),_0x42f088=>{cleanupAgentLockfile(_0x3b2fbd,_0x42f088);});process['on'](a6_0x230a('0x47'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x293b0b[a6_0x230a('0xa')](a6_0x230a('0x6b'));cleanupAgentLockfile(_0x3b2fbd,0x1);}));process['on'](a6_0x230a('0x16'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x293b0b[a6_0x230a('0xa')](a6_0x230a('0x59'));cleanupAgentLockfile(_0x3b2fbd,0x1);}));}function cleanupAgentLockfile(_0x3017d7,_0x1902b7){if((0x0,fs_1[a6_0x230a('0x9')])(_0x3017d7)){(0x0,fs_1[a6_0x230a('0x1d')])(_0x3017d7);process['exit'](_0x1902b7);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x123899=(0x0,environment_1[a6_0x230a('0x51')])();if(!_0x123899){(0x0,print_run_group_error_1[a6_0x230a('0xd')])();return process[a6_0x230a('0x26')](0x1);}output[a6_0x230a('0x45')]({'title':a6_0x230a('0x50')});const _0x1b4a37=JSON[a6_0x230a('0x31')](stripJsonComments((0x0,fs_1[a6_0x230a('0x1a')])(workspaceRoot+'/nx.json')[a6_0x230a('0x3e')]()))[a6_0x230a('0x23')][a6_0x230a('0x6')][a6_0x230a('0x1b')];const _0x5800e3=getAgentName();const _0x5bceca=new distributed_agent_api_1['DistributedAgentApi'](_0x1b4a37,_0x123899,_0x5800e3);createAgentLockfileAndSetUpListeners(_0x5bceca,_0x1b4a37,_0x5800e3);return executeTasks(_0x1b4a37,_0x5bceca)[a6_0x230a('0x36')](_0x2d6242=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x230a('0x0')])(_0x1b4a37);return _0x2d6242;}))[a6_0x230a('0x43')](_0x58732c=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x5bceca['completeRunGroupWithError'](a6_0x230a('0x2f')+_0x58732c[a6_0x230a('0x46')]+'\x22');throw _0x58732c;}));});}exports['startAgent']=startAgent;